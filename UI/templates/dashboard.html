{% extends "base.html" %}
{% set active_page = 'dashboard' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold text-gray-800 mb-6">DashBoard</h2>
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">

  <!-- Manual range selector -->
  <div class="flex flex-wrap items-center gap-2">
    <label for="startDate" class="text-sm font-medium text-gray-700">Období:</label>
    <input type="datetime-local" id="startDate" class="border px-2 py-1 rounded-md" />
    <input type="datetime-local" id="endDate" class="border px-2 py-1 rounded-md" />
    <button onclick="loadManual()" class="bg-blue-500 text-white px-4 py-1 rounded-md">Go</button>
  </div>

  <!-- Quick range buttons -->
  <div id="quickRangeButtons" class="flex flex-wrap gap-2">
    <button data-hours="1" class="range-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">1h</button>
    <button data-hours="6" class="range-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">6h</button>
    <button data-hours="12" class="range-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">12h</button>
    <button data-hours="24" class="range-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">24h</button>
    <button data-hours="72" class="range-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">3d</button>
    <button data-hours="168" class="range-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">7d</button>
  </div>

</div>


<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-4 rounded-lg shadow">
    <h3 class="font-semibold mb-2">Výška hladiny (cm)</h3>
    <div id="chartLevel"></div>
  </div>

  <div class="bg-white p-4 rounded-lg shadow">
    <h3 class="font-semibold mb-2">Odtok (l/s)</h3>
    <div id="chartOutflow"></div>
  </div>
</div>
{% endblock %}

{% block head %}
<script>
  Highcharts.setOptions({
    lang: {
      months: ['leden', 'únor', 'březen', 'duben', 'květen', 'červen',
               'červenec', 'srpen', 'září', 'říjen', 'listopad', 'prosinec'],
      weekdays: ['Neděle', 'Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota'],
      shortMonths: ['Led', 'Úno', 'Bře', 'Dub', 'Kvě', 'Čer', 'Čvc', 'Srp', 'Zář', 'Říj', 'Lis', 'Pro'],
      decimalPoint: ',',
      thousandsSep: ' '
    },
    accessibility: {
      enabled: false
    }
  });

  
    let chartLevel = null;
    let chartOutflow = null;

  async function loadDashboard(start, end) {
    const res = await fetch(`/api/dashboard?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
    const data = await res.json();

    if (data.error) {
      alert("Chyba načítání dat: " + data.error);
      return;
    }

    if (!chartLevel) {
      chartLevel = Highcharts.chart('chartLevel', {
      chart: { type: 'area' },
      title: { text: null },
      legend: {enabled: false},
      xAxis: {
        type: 'datetime',
        labels: { format: '{value:%e. %b %H:%M}' }
      },
      yAxis: { title: { text: 'cm' } },
      tooltip: {
        xDateFormat: '%A, %e. %B %Y %H:%M',
        valueDecimals: 2,
        shared: true
      },
      series: [{
        name: 'Výška hladiny',
        data: data.level,
        color: '#00c896', 
        fillColor: 'url(#gradient-0)'
      }]
    });
    } else {
      chartLevel.series[0].setData(data.level, true);
     }

    if (!chartOutflow) {
      chartOutflow = Highcharts.chart('chartOutflow', {
      chart: { type: 'area' },
      title: { text: null },
      legend: {enabled: false},
      xAxis: {
        type: 'datetime',
        labels: { format: '{value:%e. %b %H:%M}' }
      },
      yAxis: { title: { text: 'l/s' } },
      tooltip: {
        xDateFormat: '%A, %e. %B %Y %H:%M',
        valueDecimals: 2,
        shared: true
      },
      series: [{
        name: 'Odtok',
        data: data.outflow,
        color: '#00c896',
        fillColor: 'url(#gradient-0)'
      }]
    });
  } else {
      chartOutflow.series[0].setData(data.outflow, true);
     }
    }

  function loadQuick(hours) {
    const now = new Date();
    const start = new Date(now.getTime() - hours * 3600 * 1000);
    document.getElementById('startDate').value = start.toISOString().slice(0, 16);
    document.getElementById('endDate').value = now.toISOString().slice(0, 16);
    loadDashboard(start.toISOString(), now.toISOString());
  }

  function loadManual() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
    

    if (start && end) {
      loadDashboard(new Date(start).toISOString(), new Date(end).toISOString());
    } else {
      alert("Zadejte časový rozsah");
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadQuick(24);
    document.querySelectorAll('.range-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const hours = parseInt(btn.dataset.hours);
        loadQuick(hours);

    // Update button styles
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
    btn.classList.add('bg-blue-500', 'text-white');
      });
    });
  });
</script>
{% endblock %}