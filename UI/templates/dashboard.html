{% extends "base.html" %}
{% set active_page = 'dashboard' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Quick Range:</label>
    <select id="quickRange" class="border px-4 py-2 rounded-md">
      <option value="1">1 hour</option>
      <option value="6">6 hours</option>
      <option value="12">12 hours</option>
      <option value="24" selected>24 hours</option>
      <option value="72">3 days</option>
      <option value="168">7 days</option>
    </select>
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Manual Range:</label>
    <input type="datetime-local" id="startDate" class="border px-2 py-1 rounded-md" />
    <input type="datetime-local" id="endDate" class="border px-2 py-1 rounded-md" />
    <button onclick="loadManual()" class="bg-blue-500 text-white px-4 py-1 rounded-md ml-2">Go</button>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-4 rounded-lg shadow">
    <h3 class="font-semibold mb-2">V칳코ka hladiny (cm)</h3>
    <div id="chartLevel"></div>
  </div>

  <div class="bg-white p-4 rounded-lg shadow">
    <h3 class="font-semibold mb-2">Odtok (l/s)</h3>
    <div id="chartOutflow"></div>
  </div>
</div>
{% endblock %}

{% block head %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
  Highcharts.setOptions({
    lang: {
      months: ['leden', '칰nor', 'b콏ezen', 'duben', 'kv캩ten', '캜erven',
               '캜ervenec', 'srpen', 'z치콏칤', '콏칤jen', 'listopad', 'prosinec'],
      weekdays: ['Ned캩le', 'Pond캩l칤', '칔ter칳', 'St콏eda', '캛tvrtek', 'P치tek', 'Sobota'],
      shortMonths: ['Led', '칔no', 'B콏e', 'Dub', 'Kv캩', '캛er', '캛vc', 'Srp', 'Z치콏', '콎칤j', 'Lis', 'Pro'],
      decimalPoint: ',',
      thousandsSep: ' '
    }
  });

  async function loadDashboard(start, end) {
    const res = await fetch(`/api/dashboard?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
    const data = await res.json();
    if (data.error) {
      alert("Chyba na캜칤t치n칤 dat: " + data.error);
      return;
    }

    Highcharts.chart('chartLevel', {
      chart: { type: 'area' },
      title: { text: null },
      chartOptions: {defs: {
                gradient0: {
                    tagName: 'linearGradient',
                    id: 'gradient-0',
                    x1: 0,
                    y1: 0,
                    x2: 0,
                    y2: 1
                  }}},
      xAxis: {
        type: 'datetime',
        labels: { format: '{value:%e. %b %H:%M}' }
      },
      yAxis: { title: { text: 'cm' } },
      tooltip: {
        xDateFormat: '%A, %e. %B %Y %H:%M',
        valueDecimals: 2,
        shared: true
      },
      series: [{ name: 'V칳코ka hladiny', data: data.level }]
    });

    Highcharts.chart('chartOutflow', {
      chart: { type: 'area' },
      title: { text: null },
      xAxis: {
        type: 'datetime',
        labels: { format: '{value:%e. %b %H:%M}' }
      },
      yAxis: { title: { text: 'l/s' } },
      tooltip: {
        xDateFormat: '%A, %e. %B %Y %H:%M',
        valueDecimals: 2,
        shared: true
      },
      series: [{ name: 'Odtok', data: data.outflow }]
    });
  }

  function loadQuick(hours) {
    const now = new Date();
    const start = new Date(now.getTime() - hours * 3600 * 1000);

    // 游눠 Aktualizuj vstupy pro manu치ln칤 v칳b캩r
    document.getElementById('startDate').value = start.toISOString().slice(0, 16);
    document.getElementById('endDate').value = now.toISOString().slice(0, 16);

    // 游대 Spus콘 na캜ten칤 graf콢
    loadDashboard(start.toISOString(), now.toISOString());
  }

  function loadManual() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (start && end) {
      loadDashboard(new Date(start).toISOString(), new Date(end).toISOString());
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadQuick(24);
    document.getElementById('quickRange').addEventListener('change', e => {
      loadQuick(parseInt(e.target.value));
    });
  });
</script>
{% endblock %}