{% extends "base.html" %}
{% set active_page = 'weather' %}
{% block title %}Weather{% endblock %}

{% block content %}
<div class="mb-6">
  <h2 class="text-xl font-semibold mb-2">Krátkodobá předpověď</h2>
  <div id="meteogram" style="height: 500px;"></div>
</div>

<div class="mt-10">
  <h2 class="text-xl font-semibold mb-2">Dlouhodobá předpověď</h2>
  <div id="forecastCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4"></div>
</div>
{% endblock %}

{% block head %}
<script src="https://code.highcharts.com/modules/windbarb.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function () {
  const container = document.getElementById('meteogram');

  try {
    const res = await fetch('/api/weather/meteogram');
    const data = await res.json();

    const now = Date.now();
    const shortData = data.filter(d => d.time >= now && d.time <= now + 72 * 3600 * 1000);

    const temperature = shortData.map(d => [d.time, d.temperature]);
    const rain = shortData.map(d => [d.time, d.rain]);
    const pressure = shortData.map(d => [d.time, d.pressure]);

    const windDir = shortData.map(d => ({
      x: d.time,
      y: 0,
      marker: {
        symbol: 'triangle',
        rotation: d.wind_direction,
        radius: 6,
        fillColor: 'blue'
      }
    }));

    const weatherIcons = [];
    let lastIcon = null;
    shortData.forEach(d => {
      if (d.symbol_code !== lastIcon) {
        const iconUrl = `https://api.met.no/images/weathericons/png/${d.symbol_code}.png`;
        console.log('Adding icon:', iconUrl);
        weatherIcons.push({
          x: d.time,
          y: d.temperature + 1.5,
          marker: {
            symbol: `url(${iconUrl})`
            
          }
        });
        lastIcon = d.symbol_code;
      }
    }
  );

    Highcharts.chart('meteogram', {
      chart: {
        height: 500,
        zoomType: 'x',
        backgroundColor: '#ffffff',
        events: {
          load: function () {
            const chart = this;
            weatherIcons.forEach(icon => {
              const url = icon.marker.symbol.slice(4, -1); // remove url(...)
              const x = chart.xAxis[0].toPixels(icon.x) - 13;
              const y = chart.yAxis[0].toPixels(icon.y) - 13;

              chart.renderer
                .image(url, x, y, 26, 26)
                .attr({ zIndex: 10 })
                .add();
            });
          }
        }
      },
      title: { text: 'Meteogram (72 hodin)' },
      legend: { enabled: false },
      plotOptions: {
        series: {
          marker: { enabled: false }
        }
      },
      xAxis: [
        {
          type: 'datetime',
          tickInterval: 6 * 3600 * 1000,
          labels: { format: '{value:%H}' },
          opposite: false,
          gridLineWidth: 1,
          gridLineColor: '#ddd'
        },
        {
          type: 'datetime',
          tickInterval: 24 * 3600 * 1000,
          labels: {
            format: '{value:%a %e}',
            style: { fontWeight: 'bold' }
          },
          opposite: true,
          linkedTo: 0,
          gridLineWidth: 1,
          gridLineColor: '#ddd'
        }
      ],
      yAxis: [{  //temperature
          title: { text: null },
          labels: {
            format: '{value}°',
            style: { fontSize: '10px' },
            x: -3
          },
          plotLines: [{ //zero plane
            value: 0,
            color: 'var(--highcharts-neutral-color-20, #bbb)',
            width: 1,
            zIndex: 2
          }],
          maxPadding: 0.3,
          minRange: 8,
          tickInterval: 1,
          gridLineColor: 'rgba(128, 128, 128, 0.1)'
        },{//percipitation
          title: { text: null },
          labels: { enabled: false },
          gridLineWidth: 0,
          tickLength: 0,
          minRange: 10,
          min: 0
        },{ //air preasure
          allowDecimals: false,
          title: {
            text: 'hPa',
            offset: 0,
            align: 'high',
            rotation: 0,
            style: {
              fontSize: '12px',
              color: Highcharts.getOptions().colors[2]
            },
            textAlign: 'left',
            x: 3
          },
          labels: {
            style: {
              fontSize: '10px',
              color: Highcharts.getOptions().colors[2]
            },
            y: 2,
            x: 3
          },
          gridLineWidth: 0,
          opposite: true,
          showLastLabel: false
        }
      ],
      tooltip: {
        shared: true,
        xDateFormat: '%e. %b %H:%M'
      },
      series: [
        {
          name: 'Teplota',
          type: 'spline',
          data: temperature,
          yAxis: 0,
          color: '#f45b5b',
          tooltip: { valueSuffix: ' °C' }
        },
        {
          name: 'Srážky',
          type: 'column',
          data: rain,
          yAxis: 1,
          color: '#7cb5ec',
          pointWidth: 2,
          dataLabels: {
            enabled: true,
            formatter: function () { return this.y > 0 ? this.y.toFixed(1) : null; },
            style: { color: '#333', fontSize: '10px', textOutline: 'none' }
          },
          tooltip: { valueSuffix: ' mm' }
        },
        {
          name: 'Tlak vzduchu',
          type: 'spline',
          data: pressure,
          yAxis: 2,
          color: '#4CAF50',
          dashStyle: 'Dash',
          lineWidth: 1,
          tooltip: { valueSuffix: ' hPa' }
        },
        {
          name: 'Směr větru',
          type: 'scatter',
          data: windDir,
          yAxis: 1,
          tooltip: { enabled: false },
          enableMouseTracking: false
        }
      ]
    });
  } catch (err) {
    console.error('Chyba při načítání krátkodobé předpovědi:', err);
    container.innerText = 'Chyba načítání meteogramu.';
  }

  try {
    const response = await fetch('/api/weather/daily');
    const forecastData = await response.json();
    const cards = document.getElementById('forecastCards');
    cards.innerHTML = '';
    forecastData.forEach(day => {
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded shadow text-center';
      card.innerHTML = `
        <div class="text-sm text-gray-600">${day.date}</div>
        <img src="https://api.met.no/images/weathericons/png/${day.icon}.png" alt="${day.icon}" class="h-10 mx-auto my-2">
        <div class="text-lg font-semibold">${day.temp.toFixed(1)} °C</div>
        <div class="text-sm text-gray-700">💧 ${day.rain} mm</div>
        <div class="text-sm text-gray-700">💨 avg: ${day.wind_avg.toFixed(1)} | max: ${day.wind_gust.toFixed(1)} m/s</div>
      `;
      cards.appendChild(card);
    });
  } catch (err) {
    console.error('Chyba při načítání dlouhodobé předpovědi:', err);
    document.getElementById('forecastCards').innerText = 'Chyba načítání předpovědi.';
  }
});
</script>
{% endblock %}
