{% extends "base.html" %}
{% set active_page = 'weather' %}
{% block title %}Weather{% endblock %}

{% block content %}
<div class="mb-6">
  <h2 class="text-xl font-semibold mb-2">Krátkodobá předpověď</h2>
  <div id="meteogram" style="height: 500px;"></div>
</div>

<div class="mt-10">
  <h2 class="text-xl font-semibold mb-2">Dlouhodobá předpověď</h2>
  <div id="forecastCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4"></div>
</div>
{% endblock %}

{% block head %}
<script src="https://code.highcharts.com/modules/windbarb.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  const container = document.getElementById('meteogram');

  try {
    const res = await fetch('/api/weather/meteogram');
    const data = await res.json();
    if (data.error || !Array.isArray(data)) {
      container.innerText = 'Chyba načítání meteogramu.';
      return;
    }

    const temperature = data.map(d => [d.time, d.temperature]);
    const rain = data.map(d => [d.time, d.rain]);
    const pressure = data.map(d => [d.time, d.pressure]);
    const windbarbs = data.map(d => ({
      x: d.time,
      value: d.wind,
      direction: d.wind_direction
    }));
    const weatherIcons = [];
    let lastSymbol = null;

    data.forEach(d => {
      if (d.symbol_code !== lastSymbol) {
        weatherIcons.push({
          x: d.time,
          y: d.temperature + 1.5,
          marker: {
            symbol: `url(https://api.met.no/images/weathericons/png/${d.symbol_code}.png)`,
            width: 28,
            height: 28
          }
        });
        lastSymbol = d.symbol_code;
      }
    });

    Highcharts.chart('meteogram', {
      chart: {
        height: 500,
        zoomType: 'x',
        backgroundColor: '#ffffff'
      },
      title: { text: 'Meteogram' },
      legend: { enabled: false }, // 
      xAxis: [{
        type: 'datetime',
        tickInterval: 6 * 3600 * 1000,
        labels: { format: '{value:%H}' }},
        { // Top X axis
            linkedTo: 0,
            type: 'datetime',
            tickInterval: 24 * 3600 * 1000,
            labels: {
                format: '{value:<span style="font-size: 12px; font-weight: ' +
                    'bold">%a</span> %b %e}',
                align: 'left',
                x: 3,
                y: 8
            },
            opposite: true,
            tickLength: 20,
            gridLineWidth: 1
        
      }],
      yAxis: [{
        title: { text: 'Teplota (°C)' },
      }, {
        title: { text: 'Tlak (hPa)' },
        opposite: true
      }],
      tooltip: {
        shared: true,
        xDateFormat: '%e. %b %H:%M'
      },
      series: [{ 
          name: 'Teplota',
          type: 'spline',
          data: temperature,
          yAxis: 0,
          color: '#f45b5b'
        },{
          name: 'Srážky',
          type: 'column',
          data: rain,
          pointWidth: 6,
          yAxis: 0,
          color: '#7cb5ec'
      },{
        name: 'Tlak vzduchu',
        type: 'spline',
        data: pressure,
        yAxis: 1,
        dashStyle:'shortdot',
        color: '#66cc66'
      },{
        name: 'Vítr',
        type: 'column',
        data: data.map(d => [d.time, d.wind]),
        
        color: '#90caf9',
        pointWidth: 8,
        tooltip: { valueSuffix: ' m/s' }
      },{
        name: 'Ikony',
        type: 'scatter',
        data: weatherIcons,
        tooltip: { enabled: false },
        enableMouseTracking: false }
      ]
    });
  } catch (err) {
    console.error('Chyba při načítání krátkodobé předpovědi:', err);
    container.innerText = 'Chyba načítání meteogramu.';
  }


  try {
    const response = await fetch('/api/weather/daily');
    const forecastData = await response.json();
    const cards = document.getElementById('forecastCards');
    cards.innerHTML = '';

    forecastData.forEach(day => {
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded shadow text-center';
      card.innerHTML = `
        <div class="text-sm text-gray-600">${day.date}</div>
        <img src="https://api.met.no/images/weathericons/png/${day.icon}.png" alt="${day.icon}" class="h-10 mx-auto my-2">
        <div class="text-lg font-semibold">${day.temp.toFixed(1)} °C</div>
        <div class="text-sm text-gray-700">💧 ${day.rain} mm</div>
        <div class="text-sm text-gray-700">💨 avg: ${day.wind_avg.toFixed(1)} | max: ${day.wind_gust.toFixed(1)} m/s</div>
      `;
      cards.appendChild(card);
    });
  } catch (err) {
    console.error('Chyba při načítání dlouhodobé předpovědi:', err);
    document.getElementById('forecastCards').innerText = 'Chyba načítání předpovědi.';
  }
});
</script>
{% endblock %}