{% extends "base.html" %}
{% set active_page = 'weather' %}
{% block title %}Weather{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold text-gray-800 mb-6">Poƒças√≠</h2>
<div class="mb-6">
  <h2 class="text-xl font-semibold mb-2">Kr√°tkodob√° p≈ôedpovƒõƒè</h2>
  <div id="meteogram" class="bg-white p-4 rounded shadow text-center"></div>
</div>

<div class="mt-10">
  <h2 class="text-xl font-semibold mb-2">Dlouhodob√° p≈ôedpovƒõƒè</h2>
  <div id="forecastCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4"></div>
</div>
{% endblock %}

{% block head %}
<script src="https://code.highcharts.com/modules/windbarb.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function () {
  const container = document.getElementById('meteogram');

  try {
    const res = await fetch('/api/weather/meteogram');
    const data = await res.json();

    const now = Date.now();
    const shortData = data.filter(d => d.time >= now && d.time <= now + 48 * 3600 * 1000);

    const temperature = shortData.map(d => [d.time, d.temperature]);
    const rain = shortData.map(d => [d.time, d.rain]);
    const pressure = shortData.map(d => [d.time, d.pressure]);

    const windDir = shortData.map(d => ({
      x: d.time,
      y: 0,
      marker: {
        symbol: 'triangle',
        rotation: d.wind_direction,
        radius: 6,
        fillColor: 'blue'
      }
    }));

    const weatherIcons = [];
    let lastIcon = null;
    shortData.forEach(d => {
      if (d.symbol_code !== lastIcon) {
        const iconUrl = `https://api.met.no/images/weathericons/png/${d.symbol_code}.png`;
        console.log('Adding icon:', iconUrl);
        weatherIcons.push({
          x: d.time,
          y: d.temperature + 1.5,
          marker: {
            symbol: `url(${iconUrl})`
            
          }
        });
        lastIcon = d.symbol_code;
      }
    }
  );

    function weatherIconsRedraw(chart, weatherIcons) {
      // Smazat star√© ikony (volitelnƒõ si m≈Ø≈æe≈° ulo≈æit .image objekty do pole a .destroy())
      chart.weatherImages?.forEach(img => img.destroy());
      chart.weatherImages = [];

      weatherIcons.forEach(icon => {
        const url = icon.marker.symbol.slice(4, -1);
        const x = chart.xAxis[0].toPixels(icon.x) - 13;
        const y = chart.yAxis[0].toPixels(icon.y) - 13;

        const img = chart.renderer
          .image(url, x, y, 26, 26)
          .attr({ zIndex: 1 })
          .add();

        chart.weatherImages.push(img);
      });
    }

    Highcharts.chart('meteogram', {
      chart: {
        height: 500,
        spacingTop:10,
        zoomType: 'x',
        backgroundColor: '#ffffff',
        events: {
          load: function () {
            weatherIconsRedraw(this, weatherIcons);
          },
          redraw: function () {
            weatherIconsRedraw(this, weatherIcons);
          }
        }
      },
      exporting:{enabled:false},
      title: { 
        text: 'Meteo for Palkovice, Czechia',
        align: 'left',
        style: {
          whiteSpace: 'nowrap',
          textOverflow: 'ellipsis',
        }
      },
      legend: { enabled: false },
      plotOptions: {
        series: {
          marker: { enabled: false }
        }
      },
      xAxis: [
        {
          type: 'datetime',
          tickInterval: 6 * 3600 * 1000,
          minorTickInterval: 36e5,
          labels: { format: '{value:%H}' },
          opposite: false,
          gridLineWidth: 1,
          gridLineColor: '#ddd'
        },
        {
          type: 'datetime',
          tickInterval: 24 * 3600 * 1000,
          labels: {
            format: '{value:%a %e}',
            style: { fontWeight: 'bold' }
          },
          opposite: true,
          linkedTo: 0,
          gridLineWidth: 1,
          gridLineColor: '#ddd'
        }
      ],
      yAxis: [{  //temperature
          title: { text: null },
          labels: {
            format: '{value}¬∞',
            style: { fontSize: '12px' },
            x: -3
          },
          plotLines: [{ //zero plane
            value: 0,
            color: 'var(--highcharts-neutral-color-20, #bbb)',
            width: 1,
            zIndex: 2
          }],
          maxPadding: 0.3,
          minRange: 10,
          tickInterval: 1,
          gridLineColor: 'rgba(128, 128, 128, 0.1)'
        },{//percipitation
          title: { text: null },
          labels: { enabled: false },
          gridLineWidth: 0,
          tickLength: 0,
          minRange: 10,
          min: 0
        },{ //air preasure
          allowDecimals: false,
          title: {
            text: 'hPa',
            offset: 0,
            align: 'high',
            rotation: 0,
            style: {
              fontSize: '12px',
              color: '#4CAF50'
            },
            textAlign: 'left',
            x: 3
          },
          labels: {
            style: {
              fontSize: '12px',
              color: '#4CAF50'
            },
            y: 2,
            x: 3
          },
          gridLineWidth: 0,
          opposite: true,
          showLastLabel: false
        }
      ],
      tooltip: {
        shared: true,
        useHTML: true,
        formatter: function () {
          const p = this.points?.[0]?.point;
          const x = this.x;

          const dateStr = Highcharts.dateFormat('%A, %e. %B %Y', x);    // nap≈ô. pondƒõl√≠, 29. ƒçervence 2025
          const from = Highcharts.dateFormat('%H:%M', x);
          const to = Highcharts.dateFormat('%H:%M', p.to || x + 3600000);
          const icon = p.symbolName ? `üå§ ${p.symbolName}` : '';

          let s = `<small><b>${dateStr}</b><br>${from} ‚Äì ${to}</small><br><b>${icon}</b><hr style="margin:2px 0"/>`;

          this.points.forEach(pt => {
            s += `<span style="color:${pt.color}">‚óè</span> ${pt.series.name}: <b>${pt.y}`;
            if (pt.series.tooltipOptions.valueSuffix) {
              s += pt.series.tooltipOptions.valueSuffix;
            }
            s += `</b><br>`;
          });

          return s;
        }
      }
      ,
      series: [
        {
          name: 'Teplota',
          type: 'spline',
          data: temperature,
          yAxis: 0,
          color: '#f45b5b',
          tooltip: { valueSuffix: ' ¬∞C' }
        },
        {
          name: 'Sr√°≈æky',
          type: 'column',
          data: rain,
          yAxis: 1,
          color: '#7cb5ec',
          groupPadding: 0,
          pointPadding: 0.05,
          grouping: false,
          dataLabels: {
            enabled: true,
            formatter: function () { return this.y > 0 ? this.y.toFixed(1) : null; },
            style: { color: '#333', fontSize: '10px', textOutline: 'none' }
          },
          tooltip: { valueSuffix: ' mm' }
        },
        {
          name: 'Tlak vzduchu',
          type: 'spline',
          data: pressure,
          yAxis: 2,
          color: '#4CAF50',
          dashStyle: 'Dash',
          lineWidth: 1,
          tooltip: { valueSuffix: ' hPa' }
        },
        {
          name: 'Smƒõr vƒõtru',
          type: 'scatter',
          data: windDir,
          yAxis: 1,
          tooltip: { enabled: false },
          enableMouseTracking: false
        }
      ]
    });
  } catch (err) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ kr√°tkodob√© p≈ôedpovƒõdi:', err);
    container.innerText = 'Chyba naƒç√≠t√°n√≠ meteogramu.';
  }

  try {
    const response = await fetch('/api/weather/daily');
    const forecastData = await response.json();
    const cards = document.getElementById('forecastCards');
    cards.innerHTML = '';
    forecastData.forEach(day => {
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded shadow text-center';
      card.innerHTML = `
        <div class="text-sm text-gray-600">${day.date}</div>
        <img src="https://api.met.no/images/weathericons/png/${day.icon}.png" alt="${day.icon}" class="h-10 mx-auto my-2">
        <div class="text-lg font-semibold">${day.temp.toFixed(1)} ¬∞C</div>
        <div class="text-sm text-gray-700">üíß ${day.rain} mm</div>
        <div class="text-sm text-gray-700">üí® avg: ${day.wind_avg.toFixed(1)} | max: ${day.wind_gust.toFixed(1)} m/s</div>
      `;
      cards.appendChild(card);
    });
  } catch (err) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dlouhodob√© p≈ôedpovƒõdi:', err);
    document.getElementById('forecastCards').innerText = 'Chyba naƒç√≠t√°n√≠ p≈ôedpovƒõdi.';
  }
});
</script>
{% endblock %}
